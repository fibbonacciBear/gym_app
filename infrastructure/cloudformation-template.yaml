AWSTemplateFormatVersion: '2010-09-09'
Description: 'Voice Workout Tracker - Serverless Architecture with RDS PostgreSQL'

Parameters:
  Environment:
    Type: String
    Default: prod
    AllowedValues:
      - prod
      - staging
      - dev
    Description: Environment name

Conditions:
  IsProduction: !Equals [!Ref Environment, 'prod']
  IsStaging: !Equals [!Ref Environment, 'staging']
  IsDevelopment: !Equals [!Ref Environment, 'dev']
  
  PrimaryDomain:
    Type: String
    Default: titantrakr.com
    Description: Primary domain name
  
  DBMasterUsername:
    Type: String
    Default: gym_admin
    NoEcho: false
    Description: Database admin username
  
  DBMasterPassword:
    Type: String
    NoEcho: true
    MinLength: 8
    Description: Database admin password (will be stored in Secrets Manager)
  
  AnthropicApiKey:
    Type: String
    NoEcho: true
    Default: ''
    Description: Anthropic API key for voice processing
  
  OpenAIApiKey:
    Type: String
    NoEcho: true
    Default: ''
    Description: OpenAI API key (optional)

Resources:
  # ============================================================================
  # SSL Certificate (must be in us-east-1 for CloudFront)
  # ============================================================================
  SSLCertificate:
    Type: AWS::CertificateManager::Certificate
    Properties:
      DomainName: !Ref PrimaryDomain
      SubjectAlternativeNames:
        - !Sub 'www.${PrimaryDomain}'
        - !If 
          - IsStaging
          - !Ref AWS::NoValue
          - !Sub 'staging.${PrimaryDomain}'
      ValidationMethod: DNS
      Tags:
        - Key: Name
          Value: !Sub '${Environment}-gym-app-cert'
        - Key: Environment
          Value: !Ref Environment

  # ============================================================================
  # Database - RDS PostgreSQL
  # ============================================================================
  DBSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for RDS PostgreSQL
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 5432
          ToPort: 5432
          SourceSecurityGroupId: !Ref LambdaSecurityGroup
        - IpProtocol: tcp
          FromPort: 5432
          ToPort: 5432
          SourceSecurityGroupId: !Ref RDSProxySecurityGroup
      Tags:
        - Key: Name
          Value: !Sub '${Environment}-gym-db-sg'

  DBSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupDescription: Subnet group for gym app database
      SubnetIds:
        - !Ref PrivateSubnet1
        - !Ref PrivateSubnet2
      Tags:
        - Key: Name
          Value: !Sub '${Environment}-gym-db-subnet-group'

  DBInstance:
    Type: AWS::RDS::DBInstance
    DeletionPolicy: Snapshot
    Properties:
      DBInstanceIdentifier: !Sub '${Environment}-gym-app-db'
      Engine: postgres
      EngineVersion: '15.4'
      DBInstanceClass: db.t4g.micro
      AllocatedStorage: 20
      StorageType: gp3
      StorageEncrypted: true
      MasterUsername: !Ref DBMasterUsername
      MasterUserPassword: !Ref DBMasterPassword
      DBName: gymapp
      VPCSecurityGroups:
        - !Ref DBSecurityGroup
      DBSubnetGroupName: !Ref DBSubnetGroup
      BackupRetentionPeriod: 30  # Keep backups for 30 days
      PreferredBackupWindow: '03:00-04:00'  # Daily backup at 3 AM UTC
      PreferredMaintenanceWindow: 'mon:04:00-mon:05:00'
      CopyTagsToSnapshot: true
      DeleteAutomatedBackups: false  # Keep backups even if DB is deleted
      PubliclyAccessible: false
      EnableCloudwatchLogsExports:
        - postgresql
      Tags:
        - Key: Name
          Value: !Sub '${Environment}-gym-app-db'
        - Key: Environment
          Value: !Ref Environment

  # ============================================================================
  # AWS Backup (Advanced Backup Management)
  # ============================================================================
  BackupVault:
    Type: AWS::Backup::BackupVault
    Properties:
      BackupVaultName: !Sub '${Environment}-gym-app-vault'
      EncryptionKeyArn: !GetAtt BackupKMSKey.Arn

  BackupKMSKey:
    Type: AWS::KMS::Key
    Properties:
      Description: KMS key for backup vault encryption
      KeyPolicy:
        Version: '2012-10-17'
        Statement:
          - Sid: Enable IAM User Permissions
            Effect: Allow
            Principal:
              AWS: !Sub 'arn:aws:iam::${AWS::AccountId}:root'
            Action: 'kms:*'
            Resource: '*'
          - Sid: Allow Backup Service
            Effect: Allow
            Principal:
              Service: backup.amazonaws.com
            Action:
              - 'kms:CreateGrant'
              - 'kms:DescribeKey'
              - 'kms:Decrypt'
              - 'kms:Encrypt'
              - 'kms:ReEncrypt*'
              - 'kms:GenerateDataKey'
            Resource: '*'

  BackupPlan:
    Type: AWS::Backup::BackupPlan
    Properties:
      BackupPlan:
        BackupPlanName: !Sub '${Environment}-gym-app-backup-plan'
        BackupPlanRule:
          - RuleName: DailyBackup
            TargetBackupVault: !Ref BackupVault
            ScheduleExpression: 'cron(0 3 * * ? *)'  # 3 AM UTC daily
            StartWindowMinutes: 60
            CompletionWindowMinutes: 120
            Lifecycle:
              DeleteAfterDays: 30  # Keep daily backups for 30 days
          - RuleName: WeeklyBackup
            TargetBackupVault: !Ref BackupVault
            ScheduleExpression: 'cron(0 4 ? * SUN *)'  # Sunday 4 AM UTC
            StartWindowMinutes: 60
            CompletionWindowMinutes: 120
            Lifecycle:
              MoveToColdStorageAfterDays: 30
              DeleteAfterDays: 90  # Keep weekly backups for 90 days
          - RuleName: MonthlyBackup
            TargetBackupVault: !Ref BackupVault
            ScheduleExpression: 'cron(0 5 1 * ? *)'  # 1st of month, 5 AM UTC
            StartWindowMinutes: 60
            CompletionWindowMinutes: 120
            Lifecycle:
              MoveToColdStorageAfterDays: 60
              DeleteAfterDays: 365  # Keep monthly backups for 1 year

  BackupSelection:
    Type: AWS::Backup::BackupSelection
    Properties:
      BackupPlanId: !Ref BackupPlan
      BackupSelection:
        SelectionName: !Sub '${Environment}-gym-db-selection'
        IamRoleArn: !GetAtt BackupRole.Arn
        Resources:
          - !Sub 'arn:aws:rds:${AWS::Region}:${AWS::AccountId}:db:${DBInstance}'

  BackupRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: backup.amazonaws.com
            Action: 'sts:AssumeRole'
      ManagedPolicyArns:
        - 'arn:aws:iam::aws:policy/service-role/AWSBackupServiceRolePolicyForBackup'
        - 'arn:aws:iam::aws:policy/service-role/AWSBackupServiceRolePolicyForRestores'

  # ============================================================================
  # RDS Proxy (Connection Pooling for Lambda)
  # ============================================================================
  RDSProxySecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for RDS Proxy
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 5432
          ToPort: 5432
          SourceSecurityGroupId: !Ref LambdaSecurityGroup
      Tags:
        - Key: Name
          Value: !Sub '${Environment}-gym-rds-proxy-sg'

  DBSecret:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: !Sub '${Environment}-gym-app-db-credentials'
      Description: RDS PostgreSQL credentials
      SecretString: !Sub |
        {
          "username": "${DBMasterUsername}",
          "password": "${DBMasterPassword}"
        }

  RDSProxy:
    Type: AWS::RDS::DBProxy
    Properties:
      DBProxyName: !Sub '${Environment}-gym-app-proxy'
      EngineFamily: POSTGRESQL
      Auth:
        - AuthScheme: SECRETS
          SecretArn: !Ref DBSecret
          IAMAuth: DISABLED
      RoleArn: !GetAtt RDSProxyRole.Arn
      VpcSubnetIds:
        - !Ref PrivateSubnet1
        - !Ref PrivateSubnet2
      VpcSecurityGroupIds:
        - !Ref RDSProxySecurityGroup
      RequireTLS: false
      Tags:
        - Key: Name
          Value: !Sub '${Environment}-gym-app-proxy'

  RDSProxyTargetGroup:
    Type: AWS::RDS::DBProxyTargetGroup
    Properties:
      DBProxyName: !Ref RDSProxy
      TargetGroupName: default
      DBInstanceIdentifiers:
        - !Ref DBInstance

  RDSProxyRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: rds.amazonaws.com
            Action: 'sts:AssumeRole'
      ManagedPolicyArns:
        - 'arn:aws:iam::aws:policy/service-role/AmazonRDSProxyVPCAccessRole'
      Policies:
        - PolicyName: SecretsManagerAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - 'secretsmanager:GetSecretValue'
                Resource: !Ref DBSecret

  # ============================================================================
  # VPC for Database (RDS requires VPC)
  # ============================================================================
  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.0.0.0/16
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: !Sub '${Environment}-gym-vpc'

  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: !Sub '${Environment}-gym-igw'

  AttachGateway:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref VPC
      InternetGatewayId: !Ref InternetGateway

  PublicSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.1.0/24
      AvailabilityZone: !Select [0, !GetAZs '']
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub '${Environment}-gym-public-subnet-1'

  PublicSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.2.0/24
      AvailabilityZone: !Select [1, !GetAZs '']
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub '${Environment}-gym-public-subnet-2'

  PrivateSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.10.0/24
      AvailabilityZone: !Select [0, !GetAZs '']
      Tags:
        - Key: Name
          Value: !Sub '${Environment}-gym-private-subnet-1'

  PrivateSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.11.0/24
      AvailabilityZone: !Select [1, !GetAZs '']
      Tags:
        - Key: Name
          Value: !Sub '${Environment}-gym-private-subnet-2'

  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub '${Environment}-gym-public-rt'

  DefaultPublicRoute:
    Type: AWS::EC2::Route
    DependsOn: AttachGateway
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway

  PublicSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref PublicRouteTable
      SubnetId: !Ref PublicSubnet1

  PublicSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref PublicRouteTable
      SubnetId: !Ref PublicSubnet2

  # ============================================================================
  # Lambda Function (FastAPI + Mangum)
  # ============================================================================
  LambdaSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for Lambda function
      VpcId: !Ref VPC
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: !Sub '${Environment}-gym-lambda-sg'

  LambdaExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: 'sts:AssumeRole'
      ManagedPolicyArns:
        - 'arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole'
        - 'arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole'
      Policies:
        - PolicyName: SecretsManagerAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - 'secretsmanager:GetSecretValue'
                Resource: !Ref DBSecret

  GymAppFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub '${Environment}-gym-app'
      PackageType: Image
      Code:
        ImageUri: !Sub '${AWS::AccountId}.dkr.ecr.us-west-1.amazonaws.com/gym-app:${Environment}'
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 30
      MemorySize: 512
      Environment:
        Variables:
          ENVIRONMENT: !Ref Environment
          DB_HOST: !GetAtt RDSProxy.Endpoint
          DB_NAME: gymapp
          DB_SECRET_ARN: !Ref DBSecret
          ANTHROPIC_API_KEY: !Ref AnthropicApiKey
          OPENAI_API_KEY: !Ref OpenAIApiKey
          USE_OPENAI: 'false'
      VpcConfig:
        SecurityGroupIds:
          - !Ref LambdaSecurityGroup
        SubnetIds:
          - !Ref PrivateSubnet1
          - !Ref PrivateSubnet2
      Tags:
        - Key: Name
          Value: !Sub '${Environment}-gym-app'
        - Key: Environment
          Value: !Ref Environment

  GymAppFunctionUrl:
    Type: AWS::Lambda::Url
    Properties:
      AuthType: NONE
      TargetFunctionArn: !GetAtt GymAppFunction.Arn
      InvokeMode: BUFFERED

  GymAppFunctionUrlPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref GymAppFunction
      Action: lambda:InvokeFunctionUrl
      Principal: '*'
      FunctionUrlAuthType: NONE

  # ============================================================================
  # CloudFront Distribution
  # ============================================================================
  CloudFrontDistribution:
    Type: AWS::CloudFront::Distribution
    Properties:
      DistributionConfig:
        Enabled: true
        Aliases:
          - !Ref PrimaryDomain
          - !Sub 'www.${PrimaryDomain}'
        Origins:
          - Id: LambdaOrigin
            DomainName: !Select [2, !Split ['/', !GetAtt GymAppFunctionUrl.FunctionUrl]]
            CustomOriginConfig:
              HTTPSPort: 443
              OriginProtocolPolicy: https-only
              OriginSSLProtocols:
                - TLSv1.2
        DefaultCacheBehavior:
          TargetOriginId: LambdaOrigin
          ViewerProtocolPolicy: redirect-to-https
          AllowedMethods:
            - GET
            - HEAD
            - OPTIONS
            - PUT
            - POST
            - PATCH
            - DELETE
          CachedMethods:
            - GET
            - HEAD
            - OPTIONS
          # Use managed cache policy (CachingOptimized)
          CachePolicyId: 658327ea-f89d-4fab-a63d-7e88639e58f6
          # Use managed origin request policy (AllViewer)
          OriginRequestPolicyId: 216adef6-5c7f-47e4-b989-5492eafa07d3
        CacheBehaviors:
          # Cache static assets aggressively
          - PathPattern: '/css/*'
            TargetOriginId: LambdaOrigin
            ViewerProtocolPolicy: redirect-to-https
            CachePolicyId: 658327ea-f89d-4fab-a63d-7e88639e58f6
            OriginRequestPolicyId: 216adef6-5c7f-47e4-b989-5492eafa07d3
          - PathPattern: '/js/*'
            TargetOriginId: LambdaOrigin
            ViewerProtocolPolicy: redirect-to-https
            CachePolicyId: 658327ea-f89d-4fab-a63d-7e88639e58f6
            OriginRequestPolicyId: 216adef6-5c7f-47e4-b989-5492eafa07d3
          # Don't cache API calls
          - PathPattern: '/api/*'
            TargetOriginId: LambdaOrigin
            ViewerProtocolPolicy: redirect-to-https
            # Use CachingDisabled policy
            CachePolicyId: 4135ea2d-6df8-44a3-9df3-4b5a84be39ad
            OriginRequestPolicyId: 216adef6-5c7f-47e4-b989-5492eafa07d3
        ViewerCertificate:
          AcmCertificateArn: !Ref SSLCertificate
          SslSupportMethod: sni-only
          MinimumProtocolVersion: TLSv1.2_2021
        HttpVersion: http2and3
        PriceClass: PriceClass_100
      Tags:
        - Key: Name
          Value: !Sub '${Environment}-gym-app-cdn'
        - Key: Environment
          Value: !Ref Environment

  # ============================================================================
  # Route53 DNS Records
  # ============================================================================
  # DNS Records - titantrakr.com only
  PrimaryDNSRecord:
    Type: AWS::Route53::RecordSet
    Properties:
      HostedZoneId: Z062771734T6PR83RBVON  # titantrakr.com zone
      Name: !Ref PrimaryDomain
      Type: A
      AliasTarget:
        HostedZoneId: Z2FDTNDATAQYW2  # CloudFront hosted zone (global)
        DNSName: !GetAtt CloudFrontDistribution.DomainName

  WWWDNSRecord:
    Type: AWS::Route53::RecordSet
    Properties:
      HostedZoneId: Z062771734T6PR83RBVON
      Name: !Sub 'www.${PrimaryDomain}'
      Type: A
      AliasTarget:
        HostedZoneId: Z2FDTNDATAQYW2
        DNSName: !GetAtt CloudFrontDistribution.DomainName

Outputs:
  CloudFrontURL:
    Description: CloudFront distribution URL
    Value: !GetAtt CloudFrontDistribution.DomainName
    Export:
      Name: !Sub '${Environment}-gym-cloudfront-url'

  LambdaFunctionURL:
    Description: Lambda Function URL
    Value: !GetAtt GymAppFunctionUrl.FunctionUrl
    Export:
      Name: !Sub '${Environment}-gym-lambda-url'

  DatabaseEndpoint:
    Description: RDS Proxy endpoint
    Value: !GetAtt RDSProxy.Endpoint
    Export:
      Name: !Sub '${Environment}-gym-db-endpoint'

  DatabaseName:
    Description: Database name
    Value: gymapp

  PrimaryDomainURL:
    Description: Primary domain URL
    Value: !Sub 'https://${PrimaryDomain}'

  SSLCertificateArn:
    Description: ACM Certificate ARN
    Value: !Ref SSLCertificate

  BackupVaultName:
    Description: AWS Backup Vault name
    Value: !Ref BackupVault
    Export:
      Name: !Sub '${Environment}-gym-backup-vault'

  BackupPlanId:
    Description: AWS Backup Plan ID
    Value: !Ref BackupPlan

